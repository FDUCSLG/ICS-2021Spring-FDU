<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Introduction to NSCSCC</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="custom.css">
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="schedule.html">课程安排</a></li><li class="chapter-item expanded "><a href="arch-lab/index.html">体系结构部分</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="arch-lab/lab0.html">实验 0</a></li><li class="chapter-item "><a href="arch-lab/lab1.html">实验 1</a></li><li class="chapter-item "><a href="arch-lab/lab2.html">实验 2</a></li><li class="chapter-item "><a href="arch-lab/lab3.html">实验 3</a></li><li class="chapter-item "><a href="arch-lab/lab4.html">实验 4</a></li><li class="chapter-item "><a href="arch-lab/lab5.html">实验 5</a></li><li class="chapter-item "><a href="arch-lab/project.html">挑战课题</a></li></ol></li><li class="chapter-item expanded "><a href="sys-lab/index.html">操作系统部分</a></li><li class="chapter-item expanded "><a href="misc/index.html">附加资料</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="misc/external.html">外部资料</a></li><li class="chapter-item "><a href="misc/instruction.html">指令列表</a></li><li class="chapter-item "><a href="misc/verilate.html">Verilator 仿真</a></li><li class="chapter-item "><a href="misc/gtkwave.html">使用 GTKWave</a></li></ol></li><li class="chapter-item expanded "><a href="directory-structure.html">仓库目录结构</a></li><li class="chapter-item expanded affix "><a href="faq.html">常见问题</a></li><li class="chapter-item expanded affix "><a href="contributors.html">贡献者</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Introduction to NSCSCC</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<img src="asset/banner.svg" width=100% alt="Welcome!" />
<p>计算机系统基础（下）荣誉课程。2021 年春季。</p>
<ul>
<li>实验课时间：<i class="fa fa-calendar"></i> 每周一，15:25-17:05 p.m.</li>
<li>GitHub 仓库：<i class="fa fa-github"></i> <a href="https://github.com/FDUCSLG/ICS-2021Spring-FDU">FDUCSLG/ICS-2021Spring-FDU</a></li>
<li>课程首页：<i class="fa fa-link"></i> <a href="https://fducslg.github.io/ICS-2021Spring-FDU/">https://fducslg.github.io/ICS-2021Spring-FDU/</a></li>
<li>答疑平台：<i class="fa fa-slack"></i> <a href="https://fducslg.slack.com">FDUCSLG Slack</a>，#sig-architecture</li>
</ul>
<p>体系结构部分的实验安排：</p>
<table><thead><tr><th align="center">时间</th><th align="center">实验课安排</th><th align="center">时间</th><th align="center">实验课安排</th></tr></thead><tbody>
<tr><td align="center">Week 1</td><td align="center"><a href="arch-lab/lab0.html">布置实验 0</a><br><a href="arch-lab/lab1.html">布置实验 1</a></td><td align="center">Week 9</td><td align="center"><span class="red">实验 3 提交</span><br><a href="arch-lab/lab4.html">布置实验 4</a><br><a href="arch-lab/project.html">发布挑战课题</a></td></tr>
<tr><td align="center">Week 2</td><td align="center"><span class="red">实验 0 结束</span></td><td align="center">Week 10</td><td align="center"></td></tr>
<tr><td align="center">Week 3</td><td align="center"></td><td align="center">Week 11</td><td align="center"><span class="red">实验 4 提交</span><br><a href="arch-lab/lab5.html">布置实验 5</a></td></tr>
<tr><td align="center">Week 4</td><td align="center"><span class="red">实验 1 提交</span><br><a href="arch-lab/lab2.html">布置实验 2</a></td><td align="center">Week 12</td><td align="center"></td></tr>
<tr><td align="center">Week 5</td><td align="center"></td><td align="center">Week 13</td><td align="center"><span class="red">实验 5 提交</span></td></tr>
<tr><td align="center">Week 6</td><td align="center"><span class="red">实验 2 提交</span><br><a href="arch-lab/lab3.html">布置实验 3</a></td><td align="center">Week 14</td><td align="center"></td></tr>
<tr><td align="center">Week 7</td><td align="center"></td><td align="center">Week 15</td><td align="center"></td></tr>
<tr><td align="center">Week 8</td><td align="center"></td><td align="center">Week 16</td><td align="center"><span class="red">提交挑战项目</span></td></tr>
</tbody></table>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="体系结构部分"><a class="header" href="#体系结构部分">体系结构部分</a></h1>
<p>本学期体系结构部分的实验将会实现一个 MIPS32 架构的基础 5 级流水线 CPU，并且将在 FPGA 开发板上进行测试。体系结构部分一共有 5 个需要提交的实验和一个（可选的？）挑战课题。</p>
<ul>
<li>实验 0：准备开发环境和测试环境。</li>
<li>实验 1：基础的五级流水线 MIPS CPU。</li>
<li>实验 2：访存仲裁和总线延时。</li>
<li>实验 3：单周期缓存（cache）。</li>
<li>实验 4：多周期乘除法器。</li>
<li>实验 5：MIPS 异常处理。</li>
<li>挑战课题：自由选择。</li>
</ul>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="实验-0开发环境"><a class="header" href="#实验-0开发环境">实验 0：开发环境</a></h1>
<p>这个实验将指导你们准备后续实验的开发环境，并且运行我们提供的标准 CPU 实现（RefCPU），以方便大家熟悉开发和测试的流程。<strong>本实验无需提交</strong>。</p>
<h2 id="安装-vivado"><a class="header" href="#安装-vivado">安装 Vivado</a></h2>
<p><strong>本学期的实验要求统一使用 Vivado 2019.2</strong>。</p>
<p>Vivado 可以在 Windows 环境和 Linux 环境<sup class="footnote-reference"><a href="#vivado-linux">1</a></sup>下安装。请参见<a href="arch-lab/../misc/external.html#2020-%E5%B9%B4%E9%BE%99%E8%8A%AF%E6%9D%AF%E6%96%87%E6%A1%A3">龙芯杯的资料</a>中的 “<i class="fa fa-file-pdf-o"></i> A6 - Vivado 安装说明” 来完成 Vivado 的安装。安装完成后，启动 Vivado 后应该能看到类似于下面的窗口：</p>
<p><img src="arch-lab/../asset/lab0/vivado.png" alt="Vivado 启动界面" /></p>
<h3 id="对于-linux-环境"><a class="header" href="#对于-linux-环境">对于 Linux 环境</a></h3>
<p>如果你不想折腾 Vivado 的安装，可以找助教索要打包好的 Vivado 文件 “<i class="fa fa-file-zip-o"></i> xilinx.tar” 来省去下载和安装的步骤。</p>
<p>Linux 下 Vivado 的安装器不会安装 cable driver。我们需要手动安装 cable driver 后才能将 FPGA 开发板连接到 Vivado 上。请在终端中执行下面的命令来安装 cable driver：</p>
<pre><code class="language-shell">export VIVADO_ROOT=/opt/xilinx/Vivado/2019.2
cd $VIVADO_ROOT/data/xicom/cable_drivers/lin64/install_script/install_drivers
sudo ./install_drivers
</code></pre>
<p><code>VIVADO_ROOT</code> 是 Vivado 的安装位置。如果在安装时没有改动安装位置，默认位置是 <code>/opt/xilinx/Vivado/2019.2</code>。</p>
<p>如果你安装完成后找不到 Vivado 的启动项，可以在终端中启动 Vivado：</p>
<pre><code class="language-shell">cd $VIVADO_ROOT
source ./settings64.sh
vivado
</code></pre>
<p>此外你可以考虑<a href="https://forums.xilinx.com/t5/Design-Entry/Can-t-launch-vivado-2018-3-in-ubuntu/m-p/935365/highlight/true#M23934">制作一个桌面启动项</a>。</p>
<h2 id="安装-verilator"><a class="header" href="#安装-verilator">安装 Verilator</a></h2>
<p>本学期的实验会引入 Verilator 作为 Vivado 外的另一个仿真器。除了 Verilator 本身外，我们还需要一些其它的软件包才能进行完整的仿真和调试的流程。请参考课程的 GitHub 仓库首页的 “<i class="fa fa-file"></i> README.md” 中的指示来安装这些软件包。</p>
<p>我们建议你在 Linux 环境下使用 Verilator。我们会保证 Verilator 的测试至少能够在 Ubuntu 20.04 上工作。其它版本的 Linux 的发行版（例如 Ubuntu 18.04、Manjaro、ArchLinux）理论上也是可以无障碍使用 Verilator 仿真的。如果你想在 Windows 上进行实验，我们建议你使用 WSL2 或者运行一个虚拟机。</p>
<h2 id="下载-git-仓库"><a class="header" href="#下载-git-仓库">下载 Git 仓库</a></h2>
<p>本学期的实验将会使用 Git 来做版本管理。你们的所有代码都将放在 Git 仓库中的指定位置，然后通过我们提供的脚本和 Vivado 工程文件（.xpr）来进行仿真和上板测试。因此，你需要在你的系统上安装 Git。想必很多同学都已经接触过 Git 了，因此这里就不再赘述 Git 的安装和配置流程了。</p>
<p>实验内容将在后续陆续放出。为了避免与你的工作 Git 分支有冲突，请避免直接在 master/main 分支以及 lab0、lab1、lab2、... 这些分支上做改动。我们建议你新建一个 dev 分支来编写你的代码：</p>
<pre><code class="language-shell">git checkout -b dev
</code></pre>
<p>当有新的实验内容放出时（例如布置了实验 2），将你的 dev 分支 rebase 到新的实验的分支上：</p>
<pre><code class="language-shell">git fetch origin
git checkout dev
git rebase origin/lab2
</code></pre>
<p>如果在 rebase 时发生冲突，请阅读 Git 输出的消息，并根据 Git 的指示解决冲突后，再使用 <code>git rebase --continue</code> 恢复 rebase 流程。直到没有冲突产生并且 rebase 完成为止。</p>
<h2 id="refcpu"><a class="header" href="#refcpu">RefCPU</a></h2>
<p>在 Git 仓库的 <code>source/refcpu</code> 目录下，有我们提供的标准 CPU（RefCPU）的源代码。RefCPU 是一个多周期 CPU，其可以通过龙芯杯的所有功能测试和性能测试。我们本学期的测试主要是龙芯杯的功能测试和性能测试，因此你可以用 RefCPU 来作为你的流水线 CPU 的对照。当然，我们不能保证 RefCPU 完全没有 BUG。如果 RefCPU 有不符合 <a href="arch-lab/../misc/external.html#mips-%E6%9E%B6%E6%9E%84">MIPS 标准</a>的行为，请以 MIPS 标准为准，并且可以向助教反馈。</p>
<p>接下来将使用 RefCPU 来运行一些测试，方便大家熟悉开发流程。</p>
<h3 id="运行测试-1"><a class="header" href="#运行测试-1">运行测试 1</a></h3>
<p>在仓库的 <code>vivado</code> 目录下有来自龙芯杯的测试。以测试 1 为例，在 Vivado 中打开文件 <code>vivado/test1/soc_axi_func/run_vivado/mycpu_prj1/mycpu.xpr</code>。然后点击顶部菜单栏的 “Tools” → “Run Tcl Script...”：</p>
<p><img src="arch-lab/../asset/lab0/vivado-refcpu-test1-2.png" alt="“Run Tcl Script...”" /></p>
<p>在弹出的对话框中选择 Git 仓库中的文件 <code>source/refcpu/add_sources.tcl</code>。这个 Tcl 脚本会将所有的 RefCPU 的源代码加入到 Vivado 的工程中。你可能注意到 <code>source/mycpu</code> 目录下也有个 <code>add_sources.tcl</code>，这个 Tcl 脚本就是以后加入你自己的 CPU 的源码时会用到的。源码加入后等待 Vivado 处理完成，就能在 “Sources” 窗口里看到新加入的源码/模块：</p>
<p><img src="arch-lab/../asset/lab0/vivado-refcpu-test1-4.png" alt="“Sources” 窗口" /></p>
<p>之后在左侧的 “Flow Navigator” 里面点击 “Run Simulation” → “Run Behavioral Simulation” 启动仿真。第一次仿真前因为需要综合 IP 核，所以可能比较慢，需要等待若干分钟才能启动<sup class="footnote-reference"><a href="#generate-ip">2</a></sup>。之后仿真的启动速度会快很多。</p>
<p><img src="arch-lab/../asset/lab0/vivado-refcpu-test1-simulation.gif" alt="启动仿真" /></p>
<p>点击界面下侧的 “Tcl Console” 可以看到仿真测试的输出。如果测试通过，最后应该能在这里看到类似于下面的输出：</p>
<pre><code class="language-plaintext">        [17532000 ns] Test is running, debug_wb_pc = 0xbfc100d8
        [17542000 ns] Test is running, debug_wb_pc = 0xbfc10178
        [17552000 ns] Test is running, debug_wb_pc = 0xbfc10218
        [17562000 ns] Test is running, debug_wb_pc = 0xbfc102bc
----[17563425 ns] Number 8'd29 Functional Test Point PASS!!!
        [17572000 ns] Test is running, debug_wb_pc = 0xbfc008f4
==============================================================
Test end!
----PASS!!!
$finish called at time : 17579574500 ps : File &quot;/home/riteme/Downloads/ICS-2021Spring-FDU/vivado/test1/soc_axi_func/testbench/mycpu_tb.v&quot; Line 269
run: Time (s): cpu = 00:00:17 ; elapsed = 00:03:32 . Memory (MB): peak = 7061.156 ; gain = 0.000 ; free physical = 3362 ; free virtual = 19061
</code></pre>
<h3 id="测试-1-上板"><a class="header" href="#测试-1-上板">测试 1 上板</a></h3>
<p>想必你们在上学期已经学习过如何生成比特流文件并且将其烧录到 FPGA 开发板上了。在测试 1 的工程中直接生成比特流，然后上板运行，最终应该能看到下面的效果：</p>
<p><img src="arch-lab/../asset/lab0/refcpu-test1-on-board.jpg" alt="上板效果" /></p>
<p>（NOTE：这是一张老图，最新的测试 1 的数码管两侧应该显示 “1c”）</p>
<h3 id="verilator-仿真"><a class="header" href="#verilator-仿真">Verilator 仿真</a></h3>
<p>本学期会使用 Verilator 做一些额外的测试。你可以阅读附加资料中的 <a href="arch-lab/../misc/verilate.html">Verilator 仿真</a>来了解一些基本的注意事项。</p>
<p>首先在 Git 仓库根目录打开一个终端，使用以下命令来用 RefCPU 跑龙芯杯的功能测试：</p>
<pre><code class="language-shell">make vsim -j
</code></pre>
<p>最后应该能看到类似于下面的输出：</p>
<pre><code class="language-plaintext">CONFREG: store: ignored unknown destination 0x8ffc.
CONFREG: store: ignored unknown destination 0x8ffc.
CONFREG: store: ignored unknown destination 0x8ffc.
CONFREG: load: ignored unknown destination 0x8ffc.
(info) #77 completed.
(info) #78 completed.
(info) #79 completed.
(info) #80 completed.
(info) #81 completed.
(info) #82 completed.
(info) #83 completed.
(info) #84 completed.
(info) #85 completed.
(info) #86 completed.
(info) #87 completed.
(info) #88 completed.
(info) #89 completed.
(info) testbench finished in 905987 cycles (599.199 KHz).
(warn) TextDiff: 7 error(s) suppressed.
</code></pre>
<p>然后用 RefCPU 运行龙芯杯性能测试中的 CoreMark：</p>
<pre><code>make vsim -j VSIM_ARGS='--force-diff -m &quot;./misc/nscscc/coremark.coe&quot; -r &quot;./misc/std/coremark.txt&quot;'
</code></pre>
<p>最后应该能看到如下的输出：</p>
<pre><code class="language-plaintext">./build/gcc/refcpu/VTop/vmain --force-diff -m &quot;./misc/nscscc/coremark.coe&quot; -r &quot;./misc/std/coremark.txt&quot;
CONFREG: store: ignored unknown destination 0x8ffc.
CONFREG: store: ignored unknown destination 0x8ffc.
CONFREG: store: ignored unknown destination 0x8ffc.
CONFREG: store: ignored unknown destination 0x8ffc.
CONFREG: load: ignored unknown destination 0x8ffc.
CONFREG: store: ignored unknown destination 0x8ffc.
CONFREG: store: ignored unknown destination 0x8ffc.
CONFREG: store: ignored unknown destination 0x8ffc.
CONFREG: store: ignored unknown destination 0x8ffc.
CONFREG: load: ignored unknown destination 0x8ffc.
coremark test begin.
arg : 0, 0, 102, 1, 7, 1, 2000
test start
computation done
2K performance run parameters for coremark.
CoreMark Size    : 666
Total ns : 24578460
Iterations/Sec : 40
COREMARK/MHZ = (1000000.0/CPU_COUNT_PER_US)*NSEC_PER_USEC*results[0].iterations/total_ns
It equals to 1000*1000*iteration/total_ns
In this run, iterate=1, total_ns=24578460

Total ticks      : 0
Total time (secs): 0
Iterations       : 1
Compiler version : GCC4.3.0
Compiler flags   :
Memory location  : Please put data memory location here
                        (e.g. code in flash, data on heap etc)
seedcrc          : 0xe9f5
[0]crclist       : 0xe714
[0]crcmatrix     : 0x1fd7
[0]crcstate      : 0x8e3a
[0]crcfinal      : 0xe714
Correct operation validated. See readme.txt for run and reporting rules.
coremark PASS!
coremark: Total Count(SoC count) = 0x2903e1
coremark: Total Count(CPU count) = 0x290399
(info) testbench finished in 2709066 cycles (612.085 KHz).
</code></pre>
<h3 id="使用-gtkwave"><a class="header" href="#使用-gtkwave">使用 GTKWave</a></h3>
<p>Verilator 仿真可以生成 FST 格式的波形图，需要使用一个上古开源软件 <a href="https://github.com/gtkwave/gtkwave"><i class="fa fa-github"></i> GTKWave</a> 来查看。我们提供了 <code>misc/demo.fst</code> 和 <code>misc/demo.gtkw</code> 作为样例波形图文件，供大家体验 GTKWave 的使用。GTKWave 的基本操作请参阅<a href="arch-lab/../misc/gtkwave.html"> “使用 GTKWave”</a>。</p>
<hr />
<div class="footnote-definition" id="vivado-linux"><sup class="footnote-definition-label">1</sup>
<p>虽然 Xilinx 官方声明中只支持 Ubuntu，但实际上其它大多数 Linux 发行版都能正常安装和使用 Vivado。</p>
</div>
<div class="footnote-definition" id="generate-ip"><sup class="footnote-definition-label">2</sup>
<p>你也可以在 “Sources” 的 “IP Sources” 一栏里面提前生成所有的 IP 核（选中所有 IP 核，右键并点击 “Generate Output Products”）。这样可以同时综合多个 IP 核，速度更快，并且不用综合完就可以仿真。</p>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="实验-1五级流水线-mips-cpu"><a class="header" href="#实验-1五级流水线-mips-cpu">实验 1：五级流水线 MIPS CPU</a></h1>
<blockquote>
<p>先修内容：《深入学习计算机系统》Chapter 4: Pipelined Y86 CPU</p>
</blockquote>
<h2 id="11-mips-微体系结构"><a class="header" href="#11-mips-微体系结构">1.1 MIPS 微体系结构</a></h2>
<p>五级流水线，属于体系结构的范畴。不同指令集的 CPU，都可以有五级流水线的实现。</p>
<p>指令集是微体系结构的一部分，规范了指令编码等信息。</p>
<p>MIPS 属于精简指令集（Reduced Instruction Set Computing，RISC）。我们需要实现的 MIPS，部分基本信息如下：</p>
<ul>
<li>每条指令长度为 4 字节（32 位）。</li>
<li>32 个通用寄存器，每个寄存器 32 位。0 号寄存器只读恒为 0。</li>
<li>内存读写的最小单位为 1 字节（8 位）。</li>
</ul>
<h3 id="111-mips-指令集"><a class="header" href="#111-mips-指令集">1.1.1 MIPS 指令集</a></h3>
<p>详见 <a href="arch-lab/../misc/external.html#mips-%E6%9E%B6%E6%9E%84">MIPS 手册 Ⅱ</a>：<i class="fa fa-file-pdf-o"></i> Volume II: MIPS32 Instruction Set。</p>
<p>这里介绍一下本实验中将要实现的部分指令：</p>
<hr />
<p><code>01ae5821		addu t3,t5,t6</code></p>
<table><thead><tr><th>[31:26]:000000</th><th>[25:21]:01101</th><th>[20:16]:01110</th><th>[15:11]:01011</th><th>[10:6]:00000</th><th>[5:0]:100001</th></tr></thead><tbody>
<tr><td>指令类型：寄存器类型</td><td>rs: t5</td><td>rt: t6</td><td>rd: t3</td><td>全 0</td><td>ADDU</td></tr>
</tbody></table>
<p>操作：<code>Reg[rd] ← Reg[rs] + Reg[rt]</code></p>
<hr />
<p><code>25290001		addiu t1,t1,1</code></p>
<table><thead><tr><th>[31:26]:001001</th><th>[25:21]:01001</th><th>[21:16]:01001</th><th>[15:0]:0000_0000_0000_0001</th></tr></thead><tbody>
<tr><td>指令类型：ADDIU</td><td>rs: t1</td><td>rt: t1</td><td>立即数 immediate</td></tr>
</tbody></table>
<p>操作：<code>Reg[rt] = Reg[rs] + Sign_Extend(immediate)</code></p>
<p>注意：该指令中的 u 表示寄存器为无符号的，是为了忽略溢出（和 C 语言的 <code>int</code>、<code>unsigned</code> 加法语义一致），立即数仍需符号位扩展。有一部分指令的立即数是 0 扩展。</p>
<hr />
<p><code>8d0c0000 lw t4,0(t0)</code></p>
<table><thead><tr><th>[31:26]:100011</th><th>[25:21]:01000</th><th>[20:16]:01100</th><th>[15:0]:0000_0000_0000_0000</th></tr></thead><tbody>
<tr><td>指令类型：LW</td><td>base: t0</td><td>rt: t4</td><td>offset</td></tr>
</tbody></table>
<p>操作：</p>
<ul>
<li><code>vaddr ← Reg[base] + Sign_Extend(offset)</code></li>
<li><code>if (vaddr[1:0] != 2'b0) Exception(Address Exception)</code>（本实验中，可以保证 <code>vaddr</code> 是 4 字节对齐）</li>
<li><code>Reg[rt] ← LoadMemory(AddressTranslation(vaddr), size = WORD)</code></li>
</ul>
<hr />
<p><code>pc = bfc00704:  	0ff00f00		jal	bfc03c00 &lt;n1_lui_test&gt;</code></p>
<table><thead><tr><th>[31:26]:000011</th><th>[25:0]:11_1111_0000_0000_1111_0000_0000</th></tr></thead><tbody>
<tr><td>指令类型：JAL（jump and link）</td><td>instr_index</td></tr>
</tbody></table>
<p>操作：</p>
<ul>
<li><code>Reg[31] ← pc + 8</code></li>
<li>执行下一条指令时：<code>pc ← {pc[31:28], instr_index, 2'b00}</code></li>
</ul>
<p>JAL 指令常用于函数调用。</p>
<pre><code class="language-mips"># note: in MIPS, branch-type instructions (including j, beq) have a delay slot.

sample1:
beq zero, zero, here # branch if equal
instruction1
instruction2

here:
instruction3

# sequence is: beq -&gt; instruction1 -&gt; instruction3


sample2:
bne zero, zero, there # branch if not equal
instruction 4
instruction 5
instruction 6

there:
instruction 7

# sequence is: bne -&gt; instruction 4 -&gt; instruction 5
</code></pre>
<p>本实验需要实现的指令：<code>lui</code>、<code>addu</code>、<code>addiu</code>、<code>beq</code>、<code>bne</code>、<code>lw</code>、<code>or</code>、<code>slt</code>、<code>slti</code>、<code>sltiu</code>、<code>sll</code>、<code>sw</code>、<code>j</code>、<code>jal</code>、<code>jr</code>、<code>addi</code>、<code>subu</code>、<code>sltu</code>、<code>and</code>、<code>andi</code>、<code>nor</code>、<code>ori</code>、<code>xor</code>、<code>xori</code>、<code>sra</code>、<code>srl</code>、<code>jalr</code>。</p>
<h3 id="112-虚实地址转换"><a class="header" href="#112-虚实地址转换">1.1.2 虚实地址转换</a></h3>
<p>指令代码、寄存器中的地址都是虚拟地址。CPU 向内存请求时，需要提供物理地址。</p>
<p>本实验中，只要求实现简单的虚实地址转换。</p>
<pre><code class="language-verilog">typedef logic [31:0] paddr_t;
typedef logic [31:0] vaddr_t;

paddr_t paddr; // physical address
vaddr_t vaddr; // virtual address

assign paddr[27:0] = vaddr[27:0];
always_comb begin
    unique case (vaddr[31:28])
        4'h8: paddr[31:28] = 4'b0; // kseg0
        4'h9: paddr[31:28] = 4'b1; // kseg0
        4'ha: paddr[31:28] = 4'b0; // kseg1
        4'hb: paddr[31:28] = 4'b1; // kseg1
        default: paddr[31:28] = vaddr[31:28]; // useg, ksseg, kseg3
    endcase
end
</code></pre>
<p>亦可以参考 RefCPU 中模块 <code>AddressTranslator</code> 的实现。</p>
<p>例如，当指令访问地址 <code>0xbfc00380</code> 时，实际访问的物理地址应该是 <code>0x1fc00380</code>。详见 <a href="arch-lab/../misc/external.html#mips-%E6%9E%B6%E6%9E%84">MIPS 手册 Ⅲ</a>：<i class="fa fa-file-pdf-o"></i> Volume III: MIPS32 Privileged Resource Architecture，第 29 页。</p>
<h2 id="12-五级流水线"><a class="header" href="#12-五级流水线">1.2 五级流水线</a></h2>
<p>五级流水线的简单示意图如下：</p>
<p><img src="arch-lab/../asset/lab1/5-stage.png" alt="5-stage" /></p>
<p>虚线上方为内存部分的硬件，由测试文件提供。</p>
<p>写 CPU，就是实现 CPU 的内部，并用事先定好的接口进行封装。</p>
<h3 id="121-select-pc"><a class="header" href="#121-select-pc">1.2.1 Select PC</a></h3>
<p>这一阶段在 Fetch Pipeline Register 前，选择流水线所执行的下一条指令的 PC。</p>
<p>可能的来源：</p>
<ul>
<li>顺序的下一条指令（PC + 4）</li>
<li>jump 类指令（<code>{pc[31:28], instr_index, 2'b00}</code>）</li>
</ul>
<p>等等。</p>
<h3 id="122-fetch"><a class="header" href="#122-fetch">1.2.2 Fetch</a></h3>
<p>向 Instruction Memory 提供指令地址，并接收指令。</p>
<p>注意：本实验中，内存有 1 周期的固定延迟。</p>
<p>其行为类似于：</p>
<pre><code class="language-verilog">logic [127:0][31:0] memory;
logic [6:0] addr;
logic [31:0] data;
always_ff @(posedge clk) begin
    data &lt;= memory[addr];
end
</code></pre>
<p>可考虑把接受的数据直接接到下一流水段。</p>
<h3 id="123-decode"><a class="header" href="#123-decode">1.2.3 Decode</a></h3>
<p>D 阶段完成：</p>
<ul>
<li>指令解码，生成控制信号</li>
<li>从 Regfile（寄存器文件堆）中读取数据</li>
<li>判断是否跳转</li>
</ul>
<h3 id="124-execute"><a class="header" href="#124-execute">1.2.4 Execute</a></h3>
<p>E 阶段主要为 ALU。</p>
<h3 id="125-memory"><a class="header" href="#125-memory">1.2.5 Memory</a></h3>
<p>M 阶段向 Data Memory 提供数据地址，并接收数据。</p>
<p>注意：本实验中，内存有 1 周期固定延迟。</p>
<h3 id="126-writeback"><a class="header" href="#126-writeback">1.2.6 Writeback</a></h3>
<p>W 阶段向 Regfile 写数据。</p>
<h3 id="127-regfile"><a class="header" href="#127-regfile">1.2.7 Regfile</a></h3>
<p>根据 MIPS 指令集架构，每条指令最多写 1 个通用寄存器，最多读 2 个通用寄存器。所以 Regfile 应设计为 1 个写端口，2 个读端口。</p>
<p>参考代码：</p>
<pre><code class="language-verilog">typedef logic[31:0] word_t;
typedef logic[4:0] creg_addr_t;

module regfile(
	input logic clk,
    input creg_addr_t ra1, ra2, wa3,
    input logic write_enable,
    input word_t wd3
    output word_t rd1, rd2
);
    word_t [31:1] regs, regs_nxt;

    // write: sequential logic
    always_ff @(posedge clk) begin
        regs[31:1] &lt;= regs_nxt[31:1];
    end
    for (genvar i = 1; i &lt;= 31; i ++) begin
        always_comb begin
            if (wa3 == i[4:0] &amp;&amp; write_enable) begin
                regs_nxt[i[4:0]] = wd3;
            end
        end
    end


    // read: combinational logic
    assign rd1 = (ra1 == 5'b0) ? '0 : regs[ra1]; // or regs_nxt[ra1] ?
    assign rd2 = (ra2 == 5'b0) ? '0 : regs[ra2];

endmodule
</code></pre>
<h3 id="128-pipeline-register"><a class="header" href="#128-pipeline-register">1.2.8 Pipeline register</a></h3>
<p>五级流水线中，会有阻塞与气泡，所以流水线寄存器需要提供这些机制。</p>
<p>参考代码：</p>
<pre><code class="language-verilog">typedef struct packed {
    logic a;
} fetch_data_t;

module dreg (
	input logic clk, resetn,
    input fetch_data_t dataF_new,
    input logic enable, flush,
    output fetch_data_t dataF
);
    always_ff @(posedge clk) begin
        if (~resetn | flush) begin // flush overrides enable
            dataF &lt;= '0;
        end else if (enable) begin
            dataF &lt;= dataF_new;
        end
    end
endmodule
</code></pre>
<p>Tips：</p>
<ul>
<li>W 阶段流水线寄存器不允许被阻塞。</li>
<li>F 阶段流水线寄存器一般不清零。</li>
<li>M 阶段流水线寄存器阻塞时（因），E 阶段流水线寄存器通常也阻塞（果），防止丢失指令。</li>
<li>E 阶段流水线寄存器阻塞时（因），M 阶段流水线寄存器通常清零（果），防止指令被执行多次。</li>
</ul>
<h3 id="129-hazard-and-forward"><a class="header" href="#129-hazard-and-forward">1.2.9 Hazard and Forward</a></h3>
<p>这个部分代码量可能不大，但应该是本实验中最复杂的部分。</p>
<p>主要难点是数据冲突。本实验中，仅需考虑写后读（RAW）冲突。请思考：</p>
<ul>
<li>冲突阻塞部分：D 阶段取数据，E、M、W 阶段的写数据会造成冲突。哪些情况应当阻塞流水线？</li>
<li>转发部分：哪些指令写通用寄存器？电路图中的哪些数据线可作为转发来源？转发条件是什么？优先级是什么？</li>
</ul>
<p>分支预测失败的情况比较简单。D 阶段判断分支是否跳转；由于 delay slot 的设计，F 阶段的指令一定执行。所以，分支跳转不会有额外的惩罚（数据冲突可能存在）。</p>
<h3 id="1210-封装-cpu"><a class="header" href="#1210-封装-cpu">1.2.10 封装 CPU</a></h3>
<p>本实验的 CPU 的最顶层封装为 SRAM 接口。见 <code>source/mycpu/mycpu_top.sv</code>。</p>
<pre><code class="language-verilog">module mycpu_top (
    input logic clk,
    input logic resetn,  //low active
    input logic[5:0] ext_int,  //interrupt,high active

    output logic inst_sram_en,              // 指令内存总使能
    output logic[3:0] inst_sram_wen,        // 字节写使能，本实验中为全0
    output logic[31:0] inst_sram_addr,      // 地址
    output logic[31:0] inst_sram_wdata,     // 写数据
    input logic[31:0] inst_sram_rdata,      // 读数据

    output logic data_sram_en,              // 数据内存总使能
    output logic[3:0] data_sram_wen,        // 字节写使能，本实验中为全0或全1
    output logic[31:0] data_sram_addr,      // 地址
    output logic[31:0] data_sram_wdata,     // 写数据
    input logic[31:0] data_sram_rdata,      // 读数据

    //debug
    output logic[31:0] debug_wb_pc,         // w阶段pc
    output logic[3:0] debug_wb_rf_wen,      // 写使能，一般为全0或全1
    output logic[4:0] debug_wb_rf_wnum,     // 写入的寄存器
    output logic[31:0] debug_wb_rf_wdata    // 写回的数据
);
    // TODO: other circuit

endmodule
</code></pre>
<p>为了保证和后续实验在接口上的统一，我们在 CPU 内部统一使用 DBus 接口。在 <code>source/mycpu/SRAMTop.sv</code> 做了从 DBus 接口到类 SRAM 接口的转换。DBus 接口定义在 <code>source/include/common.svh</code> 中：</p>
<pre><code class="language-verilog">typedef struct packed {
    logic    valid;   // 是否有请求？
    addr_t   addr;    // 请求读写的地址
    msize_t  size;    // 读写数据的大小：1、2 或者 4 字节，分别对应 MSIZE1、MSIZE2 和 MSIZE4
    strobe_t strobe;  // 4 位的字节写使能信号
    word_t   data;    // 如果写使能不为全 0，这里放写入的数据
} dbus_req_t;

typedef struct packed {
    logic  addr_ok;  // 内存是否已经接收了地址？
    logic  data_ok;  // 内存是否完成了访存？
    word_t data;     // 请求地址处读出的数据
} dbus_resp_t;
</code></pre>
<p>对于本次实验，因为访存是固定延时，并且所有读写的数据以及指令访存都是 4 字节的，所以</p>
<ul>
<li><code>dbus_resp_t</code> 中的 <code>addr_ok</code> 和 <code>data_ok</code> 信号实际上可以忽略。</li>
<li><code>addr</code> 最低两位应该始终为 0，即地址与 4 字节对齐。</li>
<li><code>size</code> 始终为 <code>MSIZE4</code>。</li>
<li>写操作时 <code>strobe</code> 为 <code>4'b1111</code> 或 <code>4'hf</code>。</li>
</ul>
<p>你可能会注意到还有一个 IBus 接口。IBus 接口是 DBus 接口的子集，只保留了读取数据所需要的信号。此外，你的流水线部分的顶层模块文件应该是 <code>source/mycpu/MyCore.sv</code>。我们建议你将你的流水线分为多个模块来实现。你可以在 <code>source/mycpu</code> 这个目录下新建文件或者子目录。</p>
<p>你可以选择在模块 <code>SRAMTop</code> 中做地址翻译，或是在模块 <code>MyCore</code> 中做地址翻译。</p>
<h3 id="1211-连接-debug_-信号"><a class="header" href="#1211-连接-debug_-信号">1.2.11 连接 <code>debug_*</code> 信号</a></h3>
<p>龙芯杯的测试会进行 trace 的比对。这需要从你的流水线中读取一些数据。我们在 1.2.10 一节中已经看到 <code>mycpu_top</code> 最后有四个 <code>debug_*</code> 信号了。为了避免增加下层模块的接口，我们建议你使用跨模块引用来连接这些 <code>debug_*</code> 信号。例如：</p>
<pre><code class="language-verilog">// in mycpu_top.sv
assign debug_wb_pc     = top.core.writeback.pc;
assign debug_wb_rf_wen = top.core.writeback.aha ? 4'b1111 : 4'b0;
</code></pre>
<h2 id="13-发布包"><a class="header" href="#13-发布包">1.3 发布包</a></h2>
<p>用 Vivado 2019.2 打开 <code>vivado/test1_naive/soc_sram_func/run_vivado/mycpu_prj1/mycpu.xpr</code>，添加源文件后，即可开始仿真。</p>
<p>Tips：第一次仿真前，先点击 “IP Sources”，选中所有 IP 核源文件，右键，点击 “Generate Output Products”。几秒钟后，跳出 “OK”，然后再点仿真。</p>
<p><code>vivado/test1_naive/soft/obj/test.s</code> 是测试的反汇编文件，有 PC、机器码、汇编码的对应。<code>soft</code> 目录下的其他文件里，可以找到测试的 C 代码。</p>
<p><code>source/mycpu/</code> 里已经有一些代码，其中：</p>
<ul>
<li><code>mycpu_top.sv</code> 是顶层封装文件，仅需把 debug 信号连接上。</li>
<li><code>SRAMTop.sv</code> 是 SRAM 接口封装文件，需要添加虚实地址翻译。</li>
<li><code>MyCore.sv</code> 是 CPU 主体流水线文件。</li>
</ul>
<p>你可以在该目录下随意添加源文件。在 Vivado 中执行 <code>add_sources.tcl</code> 后，它们都会添加到项目里。</p>
<p><code>source/include/</code> 里有一些头文件。</p>
<p><strong>本次实验没有暂时没有使用 Verilator 进行仿真</strong>。我们会从实验 2 开始引入 Verilator，所以你需要确保你的在这次实验中编写的代码能够通过 Verilator 的编译。如果在使用 Verilator 中遇到了问题，请先阅读 <a href="arch-lab/../misc/verilate.html">Verilator 仿真</a>寻找解决方案。</p>
<h2 id="14-作业与提交"><a class="header" href="#14-作业与提交">1.4 作业与提交</a></h2>
<p>在 <code>source/mycpu/</code> 里添加你的代码，实现五级流水线 MIPS CPU。</p>
<p>本实验需要实现的指令：<code>lui</code>、<code>addu</code>、<code>addiu</code>、<code>beq</code>、<code>bne</code>、<code>lw</code>、<code>or</code>、<code>slt</code>、<code>slti</code>、<code>sltiu</code>、<code>sll</code>、<code>sw</code>、<code>j</code>、<code>jal</code>、<code>jr</code>、<code>addi</code>、<code>subu</code>、<code>sltu</code>、<code>and</code>、<code>andi</code>、<code>nor</code>、<code>ori</code>、<code>xor</code>、<code>xori</code>、<code>sra</code>、<code>srl</code>、<code>jalr</code>。</p>
<h3 id="141-通过标准"><a class="header" href="#141-通过标准">1.4.1 通过标准</a></h3>
<ol>
<li>打开原有 <code>mycpu.xpr</code>，用 <code>source/mycpu/add_sources.tcl</code> 添加源文件，上板显示两个绿灯。</li>
<li>在仓库根目录打开终端，运行 <code>make verilate TARGET=mycpu/VTop</code>，确认 Verilator 能够编译你的 CPU 代码，并且没有报告任何错误和警告。</li>
</ol>
<h3 id="142-实验报告要求"><a class="header" href="#142-实验报告要求">1.4.2 实验报告要求</a></h3>
<ul>
<li>格式：PDF</li>
<li>内容：按本文档 1.2 节的思路写即可。写好姓名学号。</li>
</ul>
<h3 id="143-提交文件格式"><a class="header" href="#143-提交文件格式">1.4.3 提交文件格式</a></h3>
<pre><code class="language-plaintext">18307130024/
├── report/（报告所在目录）
└── source/（源文件所在目录）
</code></pre>
<p>用 <code>zip -r 18307130024.zip 18307130024/</code> 打包。用 <code>unzip 18307130024.zip</code> 检查，应在当前目录下有学号目录。</p>
<h3 id="144-评分"><a class="header" href="#144-评分">1.4.4 评分</a></h3>
<p>代码 80%，报告 20%。</p>
<p><strong>Deadline：2020 年 3 月 21 日 23:59:59</strong></p>
<h2 id="15-思考"><a class="header" href="#15-思考">1.5 思考</a></h2>
<ol>
<li>流水线寄存器的 flush 信号，需要让所有信号都清零吗？</li>
<li>转发的成本是什么？有哪些限制？（板子上的组合逻辑基本部件为 LUT6 ，6 输入 1 输出，可实现 6 输入的任何给定逻辑式）</li>
<li>不同指令需要用到的流水线阶段可能不同：加法指令似乎不需要经过 Memory 阶段。能让它跳过 M 阶段吗？</li>
</ol>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="实验-2"><a class="header" href="#实验-2">实验 2</a></h1>
<p>无可奉告。</p>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="实验-3"><a class="header" href="#实验-3">实验 3</a></h1>
<p>无可奉告。</p>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="实验-4"><a class="header" href="#实验-4">实验 4</a></h1>
<p>无可奉告。</p>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="实验-4-1"><a class="header" href="#实验-4-1">实验 4</a></h1>
<p>无可奉告。</p>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="挑战课题"><a class="header" href="#挑战课题">挑战课题</a></h1>
<p>无可奉告。</p>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="操作系统部分"><a class="header" href="#操作系统部分">操作系统部分</a></h1>
<p>无可奉告。</p>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="附加资料"><a class="header" href="#附加资料">附加资料</a></h1>
<p>这一部分包含一些与实验内容相关的资料。</p>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="外部资料"><a class="header" href="#外部资料">外部资料</a></h1>
<p>这里列举了一些和本学期实验课程以及龙芯杯相关的文档。这些资料不一定都会在本学期的实验中用到。各位同学可以根据自己的需求来翻阅。</p>
<h2 id="mips-架构"><a class="header" href="#mips-架构">MIPS 架构</a></h2>
<ul>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/mips/Volume%20I:%20Introduction%20to%20MIPS32%20Architecture.pdf">Volume I: Introduction to MIPS32 Architecture</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/mips/Volume%20II:%20MIPS32%20Instruction%20Set.pdf">Volume II: MIPS32 Instruction Set</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/mips/Volume%20III:%20MIPS32%20Privileged%20Resource%20Architecture.pdf">Volume III: MIPS32 Privileged Resource Architecture</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/mips/MIPS%20%E6%8C%87%E4%BB%A4%E7%BC%96%E7%A0%81.pdf">MIPS 指令编码</a></li>
</ul>
<h2 id="soc-部分"><a class="header" href="#soc-部分">SoC 部分</a></h2>
<ul>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/soc/AMBA%20AXI%20Protocol%20Specification%20v1.0.pdf">AMBA AXI Protocol Specification v1.0</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/soc/AMBA%20AXI%20and%20ACE%20Protocol%20Specification.pdf">AMBA AXI and ACE Protocol Specification</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/soc/UltraScale%20Architecture%20Libraries%20Guide.pdf">UltraScale Architecture Libraries Guide</a></li>
<li><i class="fa fa-file"></i> <a href="https://github.com/FDUCSLG/ICS-2021Spring-FDU/blob/master/misc/doc/soc/BRAM%20%26%20LUTRAM.md">BRAM &amp; LUTRAM</a></li>
</ul>
<h2 id="2019-年龙芯杯幻灯片"><a class="header" href="#2019-年龙芯杯幻灯片">2019 年龙芯杯幻灯片</a></h2>
<ul>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/slides-2019/1%20-%20%E5%8F%82%E8%B5%9B%E6%8C%87%E5%8D%97.pdf">1 - 参赛指南</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/slides-2019/2%20-%20%E5%A4%A7%E8%B5%9B%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88%E8%A7%A3%E8%AF%BB.pdf">2 - 大赛技术方案解读</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/slides-2019/3%20-%20%E5%8A%9F%E8%83%BD%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%92%8C%E8%B0%83%E8%AF%95%E8%AF%B4%E6%98%8E.pdf">3 - 功能性能测试和调试说明</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/slides-2019/4%20-%20%E6%B1%87%E7%BC%96%E4%B8%8E%20Verilog.pdf">4 - 汇编与 Verilog</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/slides-2019/5%20-%20MIPS%20%E6%8C%87%E4%BB%A4%E9%9B%86%E4%B8%8E%20CPU%20%E8%AE%BE%E8%AE%A1.pdf">5 - MIPS 指令集与 CPU 设计</a></li>
</ul>
<h2 id="2020-年龙芯杯文档"><a class="header" href="#2020-年龙芯杯文档">2020 年龙芯杯文档</a></h2>
<ul>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/docs-2020/A0%20-%20%E5%A4%A7%E8%B5%9B%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88%E8%A7%A3%E8%AF%BB.pdf">A0 - 大赛技术方案解读</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/docs-2020/A1%20-%20%E5%8F%82%E8%B5%9B%E6%8C%87%E5%8D%97.pdf">A1 - 参赛指南</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/docs-2020/A3%20-%20%E2%80%9C%E7%B3%BB%E7%BB%9F%E8%83%BD%E5%8A%9B%E5%9F%B9%E5%85%BB%E5%A4%A7%E8%B5%9B%E2%80%9D%20MIPS%20%E6%8C%87%E4%BB%A4%E7%B3%BB%E7%BB%9F%E8%A7%84%E8%8C%83.pdf">A3 - “系统能力培养大赛” MIPS 指令系统规范</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/docs-2020/A4%20-%20%E9%BE%99%E8%8A%AF%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E6%95%99%E5%AD%A6%E5%AE%9E%E9%AA%8C%E7%AE%B1%EF%BC%88Artix-7%EF%BC%89%E4%BB%8B%E7%BB%8D.pdf">A4 - 龙芯体系结构教学实验箱（Artix-7）介绍</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/docs-2020/A6%20-%20Vivado%20%E5%AE%89%E8%A3%85%E8%AF%B4%E6%98%8E.pdf">A6 - Vivado 安装说明</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/docs-2020/A7%20-%20Vivado%20%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E.pdf">A7 - Vivado 使用说明</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/docs-2020/A8%20-%20%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E5%B7%A5%E5%85%B7%E9%93%BE%E5%AE%89%E8%A3%85.pdf">A8 - 交叉编译工具链安装</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/docs-2020/A9%20-%20CPU%20%E4%BB%BF%E7%9C%9F%E8%B0%83%E8%AF%95%E8%AF%B4%E6%98%8E.pdf">A9 - CPU 仿真调试说明</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/docs-2020/A10%20-%20FPGA%20%E5%9C%A8%E7%BA%BF%E8%B0%83%E8%AF%95%E8%AF%B4%E6%98%8E.pdf">A10 - FPGA 在线调试说明</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/docs-2020/A11%20-%20Trace%20%E6%AF%94%E5%AF%B9%E6%9C%BA%E5%88%B6%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E.pdf">A11 - Trace 比对机制使用说明</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/docs-2020/A12%20-%20%E7%B1%BB%20SRAM%20%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E.pdf">A12 - 类 SRAM 接口说明</a></li>
</ul>
<h2 id="其它"><a class="header" href="#其它">其它</a></h2>
<ul>
<li><i class="fa fa-github"></i> <a href="https://github.com/trivialmips/nontrivial-mips">NonTrivial-MIPS</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="https://riteme.site/nscscc/doc/NSCSCC%202019%20Final%20Report.pdf">NSCSCC 2019 Final Report</a></li>
<li><i class="fa fa-link"></i> <a href="https://gcc.godbolt.org/">Compiler Explorer</a></li>
<li><i class="fa fa-github"></i> <a href="https://github.com/loongson-education/nscscc-wiki">“龙芯杯” 全国大学生计算机系统能力培养大赛信息汇总</a></li>
<li><i class="fa fa-link"></i> <a href="https://www.veripool.org/projects/verilator/wiki/Manual-verilator">Verilator Manual</a></li>
<li><i class="fa fa-link"></i> <a href="https://www.xilinx.com/html_docs/xilinx2017_4/sdaccel_doc/odz1504034293215.html">Understanding FPGA Architecture</a></li>
<li><i class="fa fa-file-pdf-o"></i> <a href="http://gtkwave.sourceforge.net/gtkwave.pdf">GTKWave 3.3 Wave Analyzer User’s Guide</a></li>
</ul>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="指令列表"><a class="header" href="#指令列表">指令列表</a></h1>
<p>在下表中，“✓” 表示其所在列对应的测试中包含或者会用到这条指令。</p>
<table><thead><tr><th align="center">指令</th><th align="center">测试 1</th><th align="center">测试 2</th><th align="center">测试 3</th><th align="center">测试 4</th><th align="center">性能测试</th></tr></thead><tbody>
<tr><td align="center"><code>lui</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>addu</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>addiu</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>beq</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>bne</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>lw</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>or</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>slt</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>slti</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>sltiu</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>sll</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>sw</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>j</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>jal</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>jr</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>add</code></td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td><td align="center"></td></tr>
<tr><td align="center"><code>addi</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>sub</code></td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td><td align="center"></td></tr>
<tr><td align="center"><code>subu</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>sltu</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>and</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>andi</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>nor</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>ori</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>xor</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>xori</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>sllv</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td></tr>
<tr><td align="center"><code>sra</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>srav</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td></tr>
<tr><td align="center"><code>srl</code></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>srlv</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td></tr>
<tr><td align="center"><code>bgez</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>bgtz</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>blez</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>bltz</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>bltzal</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center"></td></tr>
<tr><td align="center"><code>bgezal</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>jalr</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>div</code></td><td align="center"></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>divu</code></td><td align="center"></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>mult</code></td><td align="center"></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>multu</code></td><td align="center"></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td></tr>
<tr><td align="center"><code>mfhi</code></td><td align="center"></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>mflo</code></td><td align="center"></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>mthi</code></td><td align="center"></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td></tr>
<tr><td align="center"><code>mtlo</code></td><td align="center"></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td></tr>
<tr><td align="center"><code>lb</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>lbu</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>lh</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>lhu</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>sb</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>sh</code></td><td align="center"></td><td align="center">✓</td><td align="center"></td><td align="center"></td><td align="center">✓</td></tr>
<tr><td align="center"><code>syscall</code></td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td><td align="center">✓</td></tr>
<tr><td align="center"><code>break</code></td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">✓</td><td align="center">✓</td></tr>
</tbody></table>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="verilator-仿真-1"><a class="header" href="#verilator-仿真-1">Verilator 仿真</a></h1>
<p>在本学期的实验中，除了 Vivado 外，我们会引入 <a href="https://www.veripool.org/wiki/verilator">Verilator</a> 来进行仿真。Verilator 是一个支持 Verilog/SystemVerilog 的周期精确（cycle-accurate）开源仿真器。Verilator 将用 Verilog/SystemVerilog 的 RTL 级描述的模块（module）综合为一个 C++ 模型。这个 C++ 模型一般称为 verilated model，在本学期的实验中是一个叫做 <code>VModel</code> 的 C++ class。然后再通过编写 C++ 代码来提供模型的输入，以及检查模型的输出。在开源领域，特别是与 RISC-V 相关的开源芯片项目，普遍使用 Verilator 进行整个 CPU 的仿真，例如东京大学的 <a href="https://github.com/rsd-devel/rsd">RSD</a>。</p>
<p>使用 Verilator 进行仿真有两个优点。首先，仿真速度一般比 Vivado 更快。以龙芯杯性能测试中的 CoreMark 为例，在 Vivado 上仿真一次通常需要十多分钟，而在 Verilator 上只用一分钟。如果不进行波形图的记录，最快只需要 3 秒就可以完成仿真。其次，使用 C++ 编写测试相比使用 SystemVeriog 而言更具灵活性，例如我们可以很方便的在 C++ 中模拟随机访存的效果，或者是将 VGA 模块的输出可视化。</p>
<p>Verilator 目前依然有许多不足之处。首先 Verilator 对 SystemVerilog 的语言支持还非常不完整，比如 unpacked 结构体是不支持的。此外 <code>interface</code>、<code>package</code> 这些关键字虽然支持，但是在功能上还不够完善。为了避免你的 SystemVerilog 代码不能通过 Verilator 的综合和不正确的仿真行为，请<strong>尽量避免</strong>以下事项：</p>
<ul>
<li>不可综合的语法，例如延时。</li>
<li><code>initial</code> 语句。</li>
<li>unpacked 数组、结构体。</li>
<li><code>interface</code>、<code>package</code>、<code>class</code>。</li>
<li>小端序位标号，如 <code>[0:31]</code>。</li>
<li>锁存器。</li>
<li><code>logic</code> 类型的 <code>X</code> 状态和高阻抗 <code>Z</code> 状态。</li>
<li>使用时钟下降沿触发。</li>
<li>异步 reset 和跨时钟域。</li>
<li>尝试屏蔽全局时钟信号。</li>
</ul>
<p>此外，我们建议每个 SystemVerilog 文件只放一个模块，并且文件名和模块名保持一致。例如，<code>SRLatch.sv</code> 里面只放模块 <code>SVLatch</code> 的定义。更详细的内容可以参见 <a href="https://www.veripool.org/projects/verilator/wiki/Manual-verilator#LANGUAGE-LIMITATIONS">Verilator 手册中的 “语言限制” 一节</a>。</p>
<h2 id="综合"><a class="header" href="#综合">综合</a></h2>
<p>Verilator 只负责将 RTL 代码综合为 <code>VModel</code>。我们已经提供好了 <code>make verilate</code> 来进行综合。例如， 如果要综合 RefCPU，其顶层模块为 <code>VTop</code>（定义在 <code>source/refcpu/VTop.sv</code> 中），则可以使用下面的命令：</p>
<pre><code class="language-shell">make verilate TARGET=refcpu/VTop
</code></pre>
<p>综合后的文件会放在 <code>build</code> 文件夹下。</p>
<p>如果在综合时出现错误或者警告，请按照错误消息进行修正。你需要确保<strong>你的代码没有任何错误和警告</strong>。Verilator 报告的大部分警告都是有意义的，并且 Verilator 在有警告的时候也会视为综合失败。当你发现有不太明白原因的警告时，请先查看 <a href="https://www.veripool.org/projects/verilator/wiki/Manual-verilator">Verilator 手册</a>中对于该警告的描述，确认其原因。如果你确认这个警告不会有影响，可以考虑忽略这个警告。</p>
<p>下面举一个实际的例子。例如，对于下面这个简单的 SR 锁存器的 Verilog 描述：</p>
<pre><code class="language-verilog">module SRLatch (
    input  logic S, R,
    output logic Q, Qn
);
    assign Q  = ~(Qn | R);
    assign Qn = ~(Q  | S);
endmodule
</code></pre>
<p>将其保存到 <code>SVLatch.sv</code>。当我们使用 <code>verilator --cc SVLatch.sv</code> 命令来综合时，会得到类似于下面的警告：</p>
<pre><code class="language-plaintext">%Warning-UNOPT: SRLatch.sv:3:21: Signal unoptimizable: Feedback to public clock or circular logic: 'Qn'
    3 |     output logic Q, Qn
      |                     ^~
                ... Use &quot;/* verilator lint_off UNOPT */&quot; and lint_on around source to disable this message.
                SRLatch.sv:3:21:      Example path: Qn
                SRLatch.sv:5:15:      Example path: ASSIGNW
                SRLatch.sv:3:18:      Example path: Q
                SRLatch.sv:6:15:      Example path: ASSIGNW
                SRLatch.sv:3:21:      Example path: Qn
%Error: Exiting due to 1 warning(s)
</code></pre>
<p>在第一行，我们可以看到警告的类型是 <code>UNOPT</code>。在警告消息里面有一个对该警告的简短的描述。我们可以前往 <a href="https://www.veripool.org/projects/verilator/wiki/Manual-verilator#ERRORS-AND-WARNINGS">Verilator 中 “警告和错误” 的文档</a>搜索关于 <code>UNOPT</code> 的详细描述：</p>
<blockquote>
<p>UNOPT</p>
<p>Warns that due to some construct, optimization of the specified signal or block is disabled. The construct should be cleaned up to improve simulation performance.</p>
<p>A less obvious case of this is when a module instantiates two submodules. Inside submodule A, signal I is input and signal O is output. Likewise in submodule B, signal O is an input and I is an output. A loop exists and a UNOPT warning will result if AI &amp; AO both come from and go to combinatorial blocks in both submodules, even if they are unrelated always blocks. This affects performance because Verilator would have to evaluate each submodule multiple times to stabilize the signals crossing between the modules.</p>
<p>Ignoring this warning will only slow simulations, it will simulate correctly.</p>
</blockquote>
<p>事实上就是锁存器的描述中有组合回路。可以通过在代码附近加上 <code>/* verilator lint_off UNOPT */</code> 来消除 <code>UNOPT</code> 警告，即</p>
<pre><code class="language-verilog">    /* verilator lint_off UNOPT */
    assign Q  = ~(Qn | R);
    assign Qn = ~(Q  | S);
    /* verilator lint_on UNOPT */
</code></pre>
<p>这样上述两行 <code>assign</code> 就不会再报告 <code>UNOPT</code> 了。如果想要消除所有文件的 <code>UNOPT</code> 警告，需要前往 <code>verilate/Makefile.verilate.mk</code> 文件，在 <code>SV_WARNINGS</code> 变量后面添加 <code>-Wno-UNOPT</code>：</p>
<pre><code class="language-makefile">SV_WARNINGS = \
	-Wall -Wpedantic \
	-Wno-IMPORTSTAR \
    -Wno-UNOPT
	# add warnings that you wanna ignore.
</code></pre>
<p>当然，请注意在你的 SystemVerilog 代码里面应该<strong>避免组合回路</strong>而不是单纯地消除这个警告！</p>
<h2 id="周期精确仿真"><a class="header" href="#周期精确仿真">周期精确仿真</a></h2>
<p>所谓周期精确仿真，是在确定模块输入的情况下，计算出模块在足够长时间后的输出。因此在周期精确仿真中没有延时的概念。可以理解为每次更新都是计算模块在无穷久后处于稳态时的输出。对于 CPU 这种由一个时钟信号驱动的设计，外层代码（C++ 代码）可以通过反复变动时钟信号的值（从 <code>0</code> 变 <code>1</code>，再从 <code>1</code> 变 <code>0</code>），就能得到每个周期内 CPU 的状态。</p>
<p>在 <code>VModel</code> 中，其核心的函数是 <code>eval</code>，它负责计算输入更新后模块的输出。如果 <code>VModel</code> 的时钟信号名为 <code>clk</code>，并且是在时钟上升沿时触发，则我们可以使用类似于下面的 C++ 代码来更新一个周期：</p>
<pre><code class="language-c++">void tick() {
    /**
     *          +--1--+     +--1--+     +--1--+
     *       A  |  B  |  A  |  B  |  A  |  B  |  A
     * clk --0--+     +--0--+     +--0--+     +--0--
     *     ----------&gt;|----------&gt;|----------&gt;|----&gt;
     *      tick()      tick()      tick()      ...
     *     ----------------------------------&gt;| ...
     *      ticks(3)
     */

    clk = 0;
    // 更新内存部分的反馈
    // oresp = ...
    eval();

    // A：此时是在时钟上升沿之前

    clk = 1;
    eval();

    // B：此时是时钟上升沿触发后
}
</code></pre>
<p>具体的例子可以参见 <code>verilate/source/refcpu/VTop/refcpu.cpp</code> 中的 <code>RefCPU::tick</code> 函数的实现。</p>
<h2 id="仿真框架"><a class="header" href="#仿真框架">仿真框架</a></h2>
<p>在本学期的实验中，我们已经提供了 Verilator 下 C++ 仿真的代码框架。代码位于 <code>verilate/source</code> 和 <code>verilate/include</code> 两个文件夹下面。仿真框架已经有内存部分和龙芯杯的 CONFREG 部分的仿真代码。<strong>你只需要按照实验文档的指示提供与你的 CPU 相关的部分的交互代码即可</strong>。仿真的命令为 <code>make vsim</code>。</p>
<p>以 RefCPU 为例，如果想要对 <code>source/refcpu/VTop.sv</code> 进行仿真，只需要指定 <code>TARGET=refcpu/VTop</code>，即</p>
<pre><code class="language-shell">make vsim TARGET=refcpu/VTop
</code></pre>
<p>上面的命令将会把 <code>verilate/source/refcpu/VTop</code> 下的 C++ 代码连同我们提供的仿真框架一起编译，得到一个可执行文件 <code>vmain</code>。这个可执行文件 <code>vmain</code> 是放在 <code>build</code> 文件夹下的。之后运行 <code>vmain</code> 进行正式的仿真。</p>
<p><code>make vsim</code> 命令有如下的参数：</p>
<ul>
<li><code>USE_CLANG</code>：是否使用 LLVM clang 编译？默认为 <code>0</code>，表示使用 GNU G++ 编译。使用 Ubuntu 18.04 的同学需要指定 <code>USE_CLANG=1</code>。</li>
<li><code>VSIM_ARGS</code>：用于指定传给可执行文件 <code>vmain</code> 的参数。例如，<code>make vsim VSIM_ARGS='-h'</code> 可以查看 <code>vmain</code> 支持哪些参数。</li>
<li><code>VSIM_OPT</code>：是否开启编译器优化？默认为 <code>0</code>。注意，<code>VSIM_OPT</code> 为 <code>0</code> 的时候，由 Verilator 生成的 C++ 代码依然会开启优化。这个参数只控制我们的仿真框架的代码。</li>
<li><code>VSIM_SANITIZE</code>：是否开启编译器的 address sanitizer 和 undefined behavior sanitizer？默认为 <code>0</code>。</li>
</ul>
<p>为了加速 C++ 代码的编译，我们建议在 <code>make</code> 的时候加上 <code>-j</code> 选项，允许 make 多进程并行编译 C++ 代码。例如</p>
<pre><code class="language-shell">make vsim -j TARGET=mycpu/VTop USE_CLANG=1
</code></pre>
<h2 id="波形图记录"><a class="header" href="#波形图记录">波形图记录</a></h2>
<p>当仿真出现问题时，我们可以使用输出调试和 GDB 来寻找出错的原因。但是这对于 SystemVerilog 代码的调试并不方便，此时我们可能需要波形图来方便调试。</p>
<p><code>make vsim</code> 在默认情况下不会记录波形图。仿真程序 <code>vmain</code> 是支持记录波形图的。可以用 <code>--fst-trace</code>/<code>-f</code> 选项来指定保存波形图文件的位置。例如</p>
<pre><code class="language-shell">make vsim VSIM_ARGS='-f build/trace.fst'
</code></pre>
<p>将会把波形图保存到当前目录下的 <code>build</code> 文件夹中，波形图文件名为 <code>trace.fst</code>。之后我们可以使用 GTKWave 来查看 FST 格式的波形图。</p>
<p>请注意，开启波形图记录后的仿真速度大约会慢 10 倍。</p>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="使用-gtkwave-1"><a class="header" href="#使用-gtkwave-1">使用 GTKWave</a></h1>
<p>打开样例波形图文件：</p>
<pre><code class="language-shell">gtkwave misc/demo.fst
</code></pre>
<p>一开始面板上是没有信号的。另外有一个文件 <code>misc/demo.gtkw</code> 是与之相关联的配置文件，也可以直接打开：</p>
<pre><code class="language-shell">gtkwave misc/demo.gtkw
</code></pre>
<p><img src="misc/./../asset/misc/demo.png" alt="样例波形图界面" /></p>
<h2 id="添加信号"><a class="header" href="#添加信号">添加信号</a></h2>
<p>当你想加入更多的信号时，点击主菜单中的 “Search” → “Signal Search Tree”（或者使用快捷键 Shift+Alt+T 呼出）。之后会看到下面的窗口：</p>
<p><img src="misc/../asset/misc/gtkwave-search-tree.png" alt="" /></p>
<p>（这个窗口貌似有 BUG，第一次打开后关掉再重开，就展开不了结构树了...）</p>
<p>你也可以用 “Search” → “Signal Search Regexp” 来用文本搜索信号名。</p>
<h2 id="生成新的波形图"><a class="header" href="#生成新的波形图">生成新的波形图</a></h2>
<p>我们的 Verilator 仿真程序一般支持使用 <code>--fst-tract</code>/<code>-f</code> 参数来指定 FST 波形图保存的位置。例如：</p>
<pre><code class="language-shell">make vsim -j VSIM_ARGS=&quot;-f ./build/trace.fst&quot;
</code></pre>
<p>将会在 <code>build</code> 目录下生成一个名为 <code>trace.fst</code> 的波形图文件。之后可以直接用 GTKWave 打开。</p>
<h2 id="配置"><a class="header" href="#配置">配置</a></h2>
<p>开学在寝室无所事事？请阅读<a href="misc/../misc/external.html"> GTKWave 用户手册</a>：<i class="fa fa-file-pdf-o"></i> GTKWave 3.3 Wave Analyzer User’s Guide。</p>
<p>不想折腾？请将下面的内容写入 <code>~/.gtkwaverc</code>：</p>
<pre><code class="language-plaintext"># 选择字体
#fontname_signals Lato 16
#fontname_logfile Lato 16
#fontname_waves JetBrains Mono Medium 14

# 快捷键
# “x” 新建一个 marker，“z” 删除一个 marker，“c” 删除所有 marker
accel &quot;/Markers/Drop Named Marker&quot; x
accel &quot;/Markers/Collect Named Marker&quot; z
accel &quot;/Markers/Collect All Named Markers&quot; c

fill_waveform 1
hide_sst 1
hier_grouping 1
hier_max_level 2
left_justify_sigs 1
use_fat_lines 1
use_roundcaps 1
wave_scrolling 1
disable_mouseover 0
highlight_wavewindow 1
splash_disable 1
color_back 041933
color_0 54c231
color_1 54c231
color_vbox 54c231
color_grid 666666
color_trans cc0000
color_vtrans cc0000
color_value eeeeee
color_umark f9fd01
enable_horiz_grid 0
page_divisor 4
</code></pre>
<h2 id="示例"><a class="header" href="#示例">示例</a></h2>
<p><img src="misc/../asset/misc/gtkwave-navigate.gif" alt="浏览波形图的简单示例" /></p>
<p>（上面演示中使用的是 GTK3 版本的 GTKWave）</p>
<h2 id="为什么要用-gtkwave"><a class="header" href="#为什么要用-gtkwave">为什么要用 GTKWave？</a></h2>
<p>GTKWave 看起来挺土的，而且貌似有很多 BUG...</p>
<p>因为没有其它软件了。开源的波形图浏览器只有这一个能打的 <code>:)</code></p>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="仓库目录结构"><a class="header" href="#仓库目录结构">仓库目录结构</a></h1>
<p>为了方便大家了解和浏览整个 Git 仓库，这里提供一个对仓库中目录结构和文件的说明。</p>
<h2 id="build"><a class="header" href="#build"><code>build</code></a></h2>
<p><code>build</code> 文件夹下用于放置编译后的文件，包括 Verilator 的综合结果和 C++ 编译过程中的生成物以及最终的可执行文件。这个文件夹下有一个 <code>.gitkeep</code> 文件，用于确保 Git 会记录这个文件夹。使用 <code>make clean</code> 命令会清空 <code>build</code> 文件夹。</p>
<p>根据 Make 的参数，编译过程中会在 <code>build</code> 文件夹下建立不同的子目录。例如 <code>build/gcc+optimized</code> 表示使用 GNU G++ 编译并且参数 <code>VSIM_OPT=1</code>（开启编译优化），而 <code>build/clang+sanitizer</code> 表示使用 LLVM clang 编译（<code>USE_CLANG=1</code>）并且参数 <code>VSIM_SANITZE=1</code>。具体的规则参见文件 <code>Makefile</code> 中变量 <code>BUILD_ROOT</code> 的设置。</p>
<h2 id="doc"><a class="header" href="#doc"><code>doc</code></a></h2>
<p>本学期实验的所有文档都位于此目录下。<code>doc/src</code> 内是文档的原始 Markdown 文件，<code>doc/book</code> 是使用 mdBook 编译后得到的网页文件。文档中使用的图片均放在 <code>doc/src/asset</code> 目录下。</p>
<h2 id="misc"><a class="header" href="#misc"><code>misc</code></a></h2>
<p>放置各种各样的资源文件，比如测试的内存加载文件（.coe）。龙芯杯的性能测试的内存文件放在 <code>misc/nscscc</code> 目录下，以方便 Verilator 仿真。</p>
<h2 id="source"><a class="header" href="#source"><code>source</code></a></h2>
<p>RTL 源代码所在的文件夹。</p>
<h3 id="sourceinclude"><a class="header" href="#sourceinclude"><code>source/include</code></a></h3>
<p>所有的 SystemVerilog 头文件（.svh）都放在这个文件下。<code>source/include/common.svh</code> 内包含一些通用的定义。<code>source/include/refcpu</code> 下放的是和 RefCPU 相关的头文件。如果你需要使用头文件，可以放在 <code>source/include/mycpu</code> 目录下。</p>
<h3 id="sourcemycpu"><a class="header" href="#sourcemycpu"><code>source/mycpu</code></a></h3>
<p>你的 SystemVerilog 源代码文件夹。这个文件夹一开始已经包含了一些模块的定义和实现：</p>
<ul>
<li><code>add_sources.tcl</code>：用于将你的 CPU 的源代码加入到 Vivado 工程中的 Tcl 脚本。</li>
<li><code>DCache.sv</code>、<code>ICache.sv</code>：数据缓存和指令缓存。这两个文件会在实验 3 的时候用到。一开始是直接用数据缓存当指令缓存用，并没有分别实现。</li>
<li><code>MyArbiter.sv</code>：你的访存仲裁器。这个文件将会在实验 2 用到。</li>
<li><code>MyCore.sv</code>：你的流水线部分。<code>MyCore</code> 这个模块一共有 6 个接口：<code>clk</code>、<code>resetn</code>、<code>ireq</code>、<code>iresp</code>、<code>dreq</code>、<code>dresp</code>，分别表示时钟信号、复位信号、指令访存请求、指令访存回复、数据访存请求和数据访存回复。其中指令访存和数据访存涉及到的结构体的定义都位于 <code>source/include/common.svh</code> 中。</li>
<li><code>mycpu_top.sv</code>：接入龙芯杯的测试的顶层模块。</li>
<li><code>SRAMTop.sv</code>：使用类 SRAM 接口时 CPU 的顶层模块。</li>
<li><code>VTop.sv</code>：使用 AXI 接口时或者进行 Verilator 仿真时 CPU 的顶层模块。</li>
</ul>
<h3 id="sourcerefcpu"><a class="header" href="#sourcerefcpu"><code>source/refcpu</code></a></h3>
<p>RefCPU 的源代码。目录结构和 <code>source/mycpu</code> 是类似的。</p>
<h3 id="sourceram"><a class="header" href="#sourceram"><code>source/ram</code></a></h3>
<p>存放 BRAM 和 LUTRAM 模块和它们的测试文件。</p>
<h3 id="sourceutil"><a class="header" href="#sourceutil"><code>source/util</code></a></h3>
<p>我们提供的辅助模块，主要是各种总线之间的转接桥。其中 <code>CBusArbiter.sv</code> 是我们提供的仲裁器的实现。你可以直接使用 <code>CBusArbiter</code> 而不需要实现自己的仲裁器 <code>MyArbiter</code>。</p>
<h2 id="verilate"><a class="header" href="#verilate"><code>verilate</code></a></h2>
<p>用于存放 Verilator 仿真时用到的 C++ 代码。<code>verilate/include</code> 是共用的 C++ 头文件，<code>verilate/source</code> 下是所有的 C++ 代码。直接放在 <code>verilate/source</code> 目录下的是通用的 C++ 代码。针对不同的模块的测试，专用的代码会放在这个文件夹的子目录下。例如 <code>verilate/source/refcpu/VTop</code> 就是用于存放测试 <code>source/refcpu/VTop.sv</code> 这个顶层模块的所有 C++ 代码。</p>
<p>在执行 <code>make vsim</code> 命令时，参数 <code>TARGET</code> 可以指定编译哪个顶层模块对应的 C++ 代码。默认 <code>TARGET=refcpu/VTop</code>，即编译 <code>verilate/source/refcpu/VTop</code> 下的代码。编译后的可执行文件名为 <code>vmain</code>，会放到 <code>build</code> 文件夹下的对应位置，例如 <code>build/gcc/refcpu/VTop/vmain</code>。</p>
<h2 id="vivado"><a class="header" href="#vivado"><code>vivado</code></a></h2>
<p>用于存放龙芯杯的测试。龙芯杯的功能测试被分为了测试 1 至测试 4，分别放在 <code>vivado/test1</code> 到 <code>vivado/test4</code> 这四个目录下。<code>vivado/test1_naive</code> 的测试内容和 <code>vivado/test1</code> 的测试内容相同，只有顶层使用的接口不同。<code>vivado/test5</code> 是龙芯杯的所有性能测试。此外除了 <code>vivado/test1_naive</code> 使用固定延时的类 SRAM 接口外，其余测试使用的都是有随机延时的 AXI 接口。</p>
<p>Vivado 的工程文件（.xpr）通常放在名为 <code>run_vivado</code> 的文件夹下，例如 <code>vivado/test1/soc_axi_func/run_vivado/mycpu_prj1/mycpu.xpr</code>。可以使用 Vivado 直接打开这个工程文件。如果某个测试需要建立多个工程，请注意复制对应的文件夹后再用 Vivado 打开。</p>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="常见问题"><a class="header" href="#常见问题">常见问题</a></h1>
<p>关于实验内容的答疑，请前往 <a href="https://fducslg.slack.com">FDUCSLG</a> 的 Slack 平台的 #sig-architecture 频道提问。如果你不想公开提问，可以单独询问助教。本页面不定期更新。</p>
<h3 id="我能拿-a-吗"><a class="header" href="#我能拿-a-吗">我能拿 A 吗？</a></h3>
<p>未来可期。</p>
<h3 id="可以退课吗"><a class="header" href="#可以退课吗">可以退课吗？</a></h3>
<p>耗子尾汁。</p>
<h3 id="这课保-b-吗"><a class="header" href="#这课保-b-吗">这课保 B+ 吗？</a></h3>
<p>无可奉告。</p>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="贡献者"><a class="header" href="#贡献者">贡献者</a></h1>
<ul>
<li>谭一凡（<a href="https://github.com/Tan-YiFan">@Tan-YiFan</a>）</li>
<li>薛振梁（<a href="https://github.com/riteme">@riteme</a>）</li>
<li>彭润宇（<a href="https://github.com/Pryest">@Pryest</a>）</li>
<li>韩晓宇（<a href="https://github.com/HatsuneHan">@HatsuneHan</a>）</li>
</ul>
<p>Powered by <a href="https://github.com/rust-lang/mdBook">mdBook</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
